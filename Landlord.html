<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apartment Manager - Landlord</title>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" type="text/css" href="css.css">
</head>
<body>
    <header>
        <h1>Apartment Manager</h1>
        <div id="username">Landlord</div>
    </header>
    <nav>
        <ul>
            <li><a onclick="showSection('home')">Home</a></li>
            <li><a onclick="showSection('listings')">Tenant Info</a></li>
            <li><a onclick="showSection('about')">About</a></li>
            <li><a onclick="showSection('contact')">Room Details</a></li>
            <li><a onclick="showSection('booking-requests')">Booking Requests</a></li>
            <li><a onclick="showSection('feedback')">Feedback</a></li>
            <li><a onclick="showSection('bills')">Tenant Bills</a></li>
            <li><a onclick="showSection('payment')">Payment History</a></li>
            <li><a onclick="logout()">Logout</a></li>
        </ul>
    </nav>
    <div class="container home" id="home">
        <h2>Welcome to Apartment Manager</h2>
        <p>Find your perfect room from our listings below. We provide the best options available in the apartment to suit all your needs.</p>
        <img src="https://www.moneycrashers.com/wp-content/uploads/2023/08/good-landlord-tips-advice-responsibilities.jpg" alt="Apartment Image" width="1125" height="751">
    </div>
    <div class="container listings" id="listings">
        <h2>Clients</h2>
        <div id="clients-list" class="clients-list">
            <!-- Clients will be listed here -->
        </div>
    </div>
    <div class="container about" id="about">
        <h2>About Us</h2>
        <p>We provide the best room listings in the apartment. Our mission is to help you find a place that you can call home.</p>
        <h2>Mission</h2>
        <p>"Our mission is to revolutionize the tenant experience by providing a seamless, integrated platform that simplifies daily interactions, enhances communication, and fosters a stronger sense of community among residents."</p>
        <h2>Vision</h2>
        <p>"Envision a future where every tenant enjoys a hassle-free living experience, characterized by effortless communication, immediate access to services, and a vibrant community atmosphere, all facilitated by innovative technology."</p>
    </div>
    <div class="container contact" id="contact">
        <div class="form-container">
            <h2>Add New Room</h2>
            <input type="number" id="room-num" placeholder="Room Number">
            <input type="number" id="room-price" placeholder="Room Price">
            <input type="text" id="room-size" placeholder="Room Size">
            <button onclick="addRoom()">Add Room</button>
        </div>
        <div id="rooms-list">
            <!-- Rooms will be listed here -->
        </div>
    </div>
    <div class="container booking-requests" id="booking-requests">
        <h2>Booking Requests</h2>
        <div id="booking-requests-list">
            <!-- Booking requests will be listed here -->
        </div>
    </div>
    <div class="container feedback" id="feedback">
        <h2>Feedback</h2>
        <div id="feedback-list">
            <!-- Feedback will be listed here -->
        </div>
    </div>
    <div class="container payment" id="payment">
        <div class="form-container">
          <h2>Payment History</h2>
        </div>
          <div id="payment-list">
              <!-- Payment history will be listed here -->
        </div>
      </div>
      <div class="container bills" id="bills">
        <div class="form-container">
            <h2>Tenant Bills</h2>
            <input type="email" id="tenant-email" placeholder="Tenant Email">
            <input type="number" id="room-bill" placeholder="Room Bill">
            <input type="number" id="elec-bill" placeholder="Electricity Bill">
            <input type="number" id="water-bill" placeholder="Water Bill">
            <button onclick="addBill()">Add Bill</button>
        </div>
        <div id="bills-list">
            <!-- Tenant bills will be listed here -->
        </div>
    </div>
    
    <footer>
        <p>&copy; 2024 Apartment Manager. All rights reserved.</p>
    </footer>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://oqeboxqhdunykevlsngo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xZWJveHFoZHVueWtldmxzbmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTcxMjM1ODYsImV4cCI6MjAzMjY5OTU4Nn0.l59O6fS7QE9ldJziNYYzSNMeNmW6fnqDcJ2wImvaoIk';
        const connect = createClient(supabaseUrl, supabaseKey);
    
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.container');
            sections.forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
        }
    
        document.addEventListener('DOMContentLoaded', async function() {
            showSection('home');
            fetchClients();
            fetchRooms();
            fetchBookingRequests();
            fetchFeedback();
            fetchPaymentHistory();
            fetchBills();

            const { data, error } = await connect.auth.getSession();
            const div = document.querySelector('.display');
            console.log(data.session)
            if (!div) {
                console.error('Display element not found');
                return;
            }
        });
    
        async function fetchClients() {
            const { data, error } = await connect.from('users').select().eq('role', 'tenant');
            if (error) {
                console.error('Error fetching clients:', error);
                return;
            }
    
            const clientsList = document.getElementById('clients-list');
            clientsList.innerHTML = '';
    
            data.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'room';
                clientDiv.innerHTML = `
                    <h2>${client.name}</h2>
                    <p>Age: ${client.age}</p>
                    <p>Phone number: ${client.phone_number}</p>
                    <p>Email: ${client.email}</p>
                    <p>Date started: ${client.date_started}</p>
                `;
                const editButton = document.createElement('button');
                editButton.innerText = "Edit";
                editButton.addEventListener('click', () => editClient(client.name));
                clientDiv.appendChild(editButton);
                const deleteButton = document.createElement('button');
                deleteButton.innerText = "Delete";
                deleteButton.addEventListener('click', () => deleteClient(client.name));
                clientDiv.appendChild(deleteButton);
                clientsList.appendChild(clientDiv);
            });
        }

        async function editClient(name) {
            const field = prompt("Enter the field you want to update (name, age, phone_number, email, date_started):");
            const newValue = prompt(`Enter the new value for ${field}:`);
    
            const updatedField = {};
            updatedField[field] = newValue;
    
            const { data, error } = await connect.from('users').update(updatedField).eq('name', name);
    
            if (error) {
                console.error('Error updating client:', error);
                return;
            }
    
            fetchClients();
        }
    
        async function deleteClient(name) {
            const confirmation = confirm(`Are you sure you want to delete the tenant: ${name}?`);
            if (confirmation) {
                const { data, error } = await connect.from('users').delete().eq('name', name);
    
                if (error) {
                    console.error('Error deleting client:', error);
                    alert('Tenant not deleted');
                    return;
                }
    
                alert('Successfully deleted tenant');
                fetchClients();
            } else {
                alert('Tenant not deleted');
            }
        }
    
    async function addRoom() {
    const room_num = document.getElementById('room-num').value;
    const room_price = document.getElementById('room-price').value;
    const room_size = document.getElementById('room-size').value;

    if (!room_num || !room_price || !room_size) {
        alert('All fields are required.');
        return;
    }

    const parsedRoomNum = parseInt(room_num);
    const parsedRoomPrice = parseFloat(room_price);

    const { data, error } = await connect.from('room_details').insert([
        { room_num: parsedRoomNum, room_price: parsedRoomPrice, room_size, status: 'available' }
    ]);

    if (error) {
        console.error('Error adding room:', error);
        alert('Error adding room');
        return;
    }

    document.getElementById('room-num').value = '';
    document.getElementById('room-price').value = '';
    document.getElementById('room-size').value = '';

    alert('Room added successfully');
    fetchRooms();
}


async function fetchRooms() {
    const { data, error } = await connect.from('room_details').select().in('status', ['available', 'booked']);
    if (error) {
        console.error('Error fetching rooms:', error);
        return;
    }

    const roomsList = document.getElementById('rooms-list');
    roomsList.innerHTML = '';

    data.forEach(room => {
        const roomDiv = document.createElement('div');
        roomDiv.className = 'room';
        roomDiv.innerHTML = `
            <h2>Room ${room.room_num}</h2>
            <p>Price: ${room.room_price}</p>
            <p>Size: ${room.room_size}</p>
            <p>Status: ${room.status}</p>
        `;
        const editButton = document.createElement('button');
        editButton.innerText = "Edit";
        editButton.addEventListener('click', () => editRoom(room.room_num));
        roomDiv.appendChild(editButton);
        const deleteButton = document.createElement('button');
        deleteButton.innerText = "Delete";
        deleteButton.addEventListener('click', () => deleteRoom(room.room_num));
        roomDiv.appendChild(deleteButton);

        if (room.status === 'booked') {
            const unbookButton = document.createElement('button');
            unbookButton.innerText = "Unbook";
            unbookButton.addEventListener('click', () => unbookRoom(room.room_num));
            roomDiv.appendChild(unbookButton);
        }

        roomsList.appendChild(roomDiv);
    });
}



    
        async function editRoom(room_num) {
            const field = prompt("Enter the field you want to update (room_num, room_price, room_size, status):");
            const newValue = prompt(`Enter the new value for ${field}:`);
    
            const updatedField = {};
            updatedField[field] = newValue;
    
            const { data, error } = await connect.from('room_details').update(updatedField).eq('room_num', room_num);
    
            if (error) {
                console.error('Error updating room:', error);
                return;
            }
    
            fetchRooms();
        }
    
        async function deleteRoom(room_num) {
            const confirmation = confirm(`Are you sure you want to delete the room number: ${room_num}?`);
            if (confirmation) {
                const { data, error } = await connect.from('room_details').delete().eq('room_num', room_num);
    
            if (error) {
                console.error('Error deleting room:', error);
                return;
            }
    
            fetchRooms();
        }
    
        async function fetchBookingRequests() {
            const { data, error } = await connect.from('booking_requests').select().eq('status', 'Pending');
            if (error) {
                console.error('Error fetching booking requests:', error);
                return;
            }

            const bookingRequestsList = document.getElementById('booking-requests-list');
            bookingRequestsList.innerHTML = '';

            data.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'booking-request';
                requestDiv.innerHTML = `
                    <h2>Booking Request</h2>
                    <p>User ID: ${request.user_id}</p>
                    <p>Room Number: ${request.room_num}</p>
                    <p>Status: ${request.status}</p>
                    <p>Date Requested: ${request.date_requested}</p>
                `;
                bookingRequestsList.appendChild(requestDiv);
            });
        }
        }
        setInterval(fetchBookingRequests, 10000); 
    
        async function approveRequest(id) {
            const { data, error } = await connect.from('booking_requests').update({ status: 'approved' }).eq('id', id);
            if (error) {
                console.error('Error approving request:', error);
                return;
            }
            fetchBookingRequests();
        }
    
        async function rejectRequest(id) {
            const { data, error } = await connect.from('booking_requests').update({ status: 'rejected' }).eq('id', id);
            if (error) {
                console.error('Error rejecting request:', error);
                return;
            }
            fetchBookingRequests();
        }
    
    async function unbookRoom(room_num) {
    const confirmation = confirm(`Are you sure you want to unbook the room number: ${room_num}?`);
    if (confirmation) {
        const { data, error } = await connect.from('room_details').update({ status: 'available' }).eq('room_num', room_num);
        if (error) {
            console.error('Error unbooking room:', error);
            return;
        }

        alert('Room successfully unbooked');
        fetchRooms();
    }
}


async function fetchBookingRequests() {
    const { data, error } = await connect.from('room_details').select().eq('status', 'pending');
    if (error) {
        console.error('Error fetching booking requests:', error);
        return;
    }

    const bookingRequestsList = document.getElementById('booking-requests-list');
    bookingRequestsList.innerHTML = '';

    data.forEach(request => {
        const requestDiv = document.createElement('div');
        requestDiv.className = 'room';
        requestDiv.innerHTML = `
            <h2>Room ${request.room_num}</h2>
            <p>Price: ${request.room_price}</p>
            <p>Size: ${request.room_size}</p>
            <p>Status: ${request.status}</p>
            <p>Email: ${request.booker}</p> <!-- Display the booker's email -->
            <button onclick="updateBookingStatus(${request.room_num}, 'accepted')">Accept</button>
            <button onclick="updateBookingStatus(${request.room_num}, 'denied')">Deny</button>
        `;
        bookingRequestsList.appendChild(requestDiv);
    });
}

    
   
async function updateBookingStatus(room_num, status) {
    const confirmation = confirm(`Are you sure you want to ${status} the booking request for room number: ${room_num}?`);
    if (confirmation) {
        let updateStatus = status;
        if (status === 'denied') {
            updateStatus = 'available';
        } else if (status === 'accepted') {
            updateStatus = 'booked';
        }

        const { data, error } = await connect.from('room_details').update({ status: updateStatus }).eq('room_num', room_num);
        if (error) {
            console.error('Error updating booking status:', error);
            return;
        }

        fetchBookingRequests();
        fetchRooms(); 
    } else {
        alert(`Booking request not ${status}`);
    }
}


async function fetchFeedback() {
    const { data, error } = await connect.from('feedback').select();
    if (error) {
        console.error('Error fetching feedback:', error);
        return;
    }

    const feedbackList = document.getElementById('feedback-list');
    feedbackList.innerHTML = '';

    data.forEach(feedback => {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'room';
        feedbackDiv.innerHTML = `
            <h2>Respondent: ${feedback.feedbacker}</h2>
            <p>${feedback.feedback_text}</p>
            <p>Date Submitted: ${feedback.date_submitted}</p>
            <button onclick="removeFeedback(${feedback.id})">Ok</button>
        `;
        const containerDiv = document.createElement('div');
        containerDiv.className = 'feedback-container';
        containerDiv.appendChild(feedbackDiv);
        feedbackList.appendChild(containerDiv);
    });
}


async function removeFeedback(feedbackId) {
    const { data, error } = await connect.from('feedback').delete().eq('id', feedbackId);
    if (error) {
        console.error('Error removing feedback:', error);
        return;
    }

    alert('Feedback removed successfully');
    fetchFeedback();
}

async function fetchPaymentHistory() {
    const { data, error } = await connect.from('payment_details').select();
    
    if (error) {
        console.error('Error fetching payment history:', error);
        return;
    }

    const paymentHistoryList = document.getElementById('payment-list');
    paymentHistoryList.innerHTML = '';

    data.forEach(payment => {
        const paymentDiv = document.createElement('div');
        paymentDiv.className = 'room';
        paymentDiv.innerHTML = `
            <h2>Resident: ${payment.payer || 'N/A'}</h2>
            <p>Date: ${payment.date || 'N/A'}</p>
            <p>Amount: ₱${payment.amount}</p>
            <p>Payment Method: ${payment.method}</p>
            <p>Status: ${payment.status}</p>
        `;

        if (payment.status === 'Pending') {
            const receivedButton = document.createElement('button');
            receivedButton.innerText = "Received";
            receivedButton.addEventListener('click', () => updatePaymentStatus(payment.id, 'Received'));
            paymentDiv.appendChild(receivedButton);

            const notReceivedButton = document.createElement('button');
            notReceivedButton.innerText = "Not Received";
            notReceivedButton.addEventListener('click', () => updatePaymentStatus(payment.id, 'Not Received'));
            paymentDiv.appendChild(notReceivedButton);
        }

        paymentHistoryList.appendChild(paymentDiv);
    });
}

async function updatePaymentStatus(paymentId, status) {
    const confirmation = confirm(`Are you sure you want to mark this payment as ${status}?`);
    if (confirmation) {
        const { data, error } = await connect.from('payment_details').update({ status: status }).eq('id', paymentId);
        if (error) {
            console.error('Error updating payment status:', error);
            alert(`Error updating payment status to ${status}`);
            return;
        }

        alert(`Payment status updated to ${status}`);
        fetchPaymentHistory();
    }
}

async function addBill() {
    const tenantGmail = document.getElementById('tenant-email').value;
    const roomBill = parseFloat(document.getElementById('room-bill').value);
    const waterBill = parseFloat(document.getElementById('water-bill').value);
    const elecBill = parseFloat(document.getElementById('elec-bill').value);

    if (!tenantGmail || isNaN(roomBill) || isNaN(waterBill) || isNaN(elecBill)) {
        alert('Please fill all fields with valid data.');
        return;
    }

    try {
        const { data, error } = await connect
            .from('bills')
            .insert([
                {
                    tenant_gmail: tenantGmail,
                    room_bill: roomBill,
                    elec_bill: elecBill,
                    water_bill: waterBill,
                    status: 'Unpaid' 
                }
            ]);

        if (error) {
            console.error('Error inserting data:', error);
            alert('Error inserting data: ' + error.message);
        } else {
            console.log('Data inserted successfully:', data);
            alert('Bill added successfully!');
            document.getElementById('tenant-email').value = '';
            document.getElementById('room-bill').value = '';
            document.getElementById('water-bill').value = '';
            document.getElementById('elec-bill').value = '';
        }
    } catch (err) {
        console.error('Unexpected error:', err);
        alert('An unexpected error occurred. Please try again.');
    }
}


async function fetchBills() {
  const { data, error } = await connect.from('bills').select();
  if (error) {
    console.error('Error fetching bills:', error);
    return;
  }

  const billsList = document.getElementById('bills-list');
  billsList.innerHTML = '';

  data.forEach((bill) => {
    const billDiv = document.createElement('div');
    billDiv.className = 'room';
    billDiv.innerHTML = `
      <h2>Tenant Gmail: ${bill.tenant_gmail}</h2>
      <p>Room Bill: ₱${bill.room_bill}</p>
      <p>Water Bill: ₱${bill.water_bill}</p>
      <p>Electricity Bill: ₱${bill.elec_bill}</p>
      <p id="status-${bill.bill_id}">Status: ${bill.status}</p>
      <button onclick="markAsPaid(${bill.bill_id})">Mark as Paid</button>
    `;
    billsList.appendChild(billDiv);
  });
}


async function markAsPaid(billId) {
  const { data, error } = await connect
    .from('bills')
    .update({ status: 'Paid' })
    .eq('bill_id', billId); 

  if (error) {
    console.error('Error marking bill as paid:', error);
    alert('Error marking bill as paid');
    return;
  }

  alert('Bill marked as paid successfully');
  
  document.getElementById(`status-${billId}`).innerText = 'Paid';
}

document.addEventListener('DOMContentLoaded', fetchBills);



        function logout() {
        const { auth } = createClient(supabaseUrl, supabaseKey);

        auth.signOut().then(response => {
          if (response.error) {
            console.error('Error during logout:', response.error.message);
            return;
          }

          window.location.href = 'login.html';
        }).catch(error => {
          console.error('Error during logout:', error.message);
        });
      }


      
    </script>
</body>
</html>